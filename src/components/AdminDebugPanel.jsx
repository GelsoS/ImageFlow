"use client"

import { useState } from "react"
import { supabase } from "../supabaseClient"
import "../styles/AdminDebugPanel.css"

function AdminDebugPanel({ user }) {
  const [paymentId, setPaymentId] = useState("")
  const [loading, setLoading] = useState(false)
  const [validating, setValidating] = useState(false)
  const [validationResult, setValidationResult] = useState(null)
  const [result, setResult] = useState(null)

  // üîç Valida√ß√£o completa do Payment ID
  async function validatePaymentId(id) {
    if (!id.trim()) {
      setValidationResult(null)
      return
    }

    setValidating(true)
    setValidationResult(null)

    try {
      console.log("üîç Validando Payment ID:", id)

      // ETAPA 1: Verificar se o payment_id j√° foi usado no nosso sistema
      const { data: existingSubscription, error: dbError } = await supabase
        .from("subscriptions")
        .select("user_id, payment_id, status, created_at")
        .eq("payment_id", id.trim())
        .maybeSingle()

      if (dbError) {
        console.error("Erro ao verificar payment_id no banco:", dbError)
        setValidationResult({
          valid: false,
          message: "‚ùå Erro ao verificar pagamento no banco de dados",
          type: "error",
        })
        return
      }

      if (existingSubscription) {
        console.log("‚ö†Ô∏è Payment ID j√° utilizado:", existingSubscription)

        if (existingSubscription.user_id === user.id) {
          setValidationResult({
            valid: false,
            message: "‚ö†Ô∏è Voc√™ j√° utilizou este ID de pagamento",
            type: "warning",
            details: `Usado em: ${new Date(existingSubscription.created_at).toLocaleDateString()}`,
          })
        } else {
          setValidationResult({
            valid: false,
            message: "üö® Este ID de pagamento j√° foi utilizado por outra conta",
            type: "error",
            details: "Cada pagamento s√≥ pode ser usado uma vez",
          })
        }
        return
      }

      // ETAPA 2: Verificar se o pagamento existe no Mercado Pago
      console.log("üîç Verificando pagamento no Mercado Pago...")

      const mpResponse = await fetch("/api/debug/validate-payment", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          paymentId: id.trim(),
          userId: user.id,
        }),
      })

      const mpResult = await mpResponse.json()

      if (!mpResponse.ok) {
        console.error("Erro na valida√ß√£o do MP:", mpResult)
        setValidationResult({
          valid: false,
          message: mpResult.error || "‚ùå Erro ao validar pagamento",
          type: "error",
          details: mpResult.details || "Verifique se o ID do pagamento est√° correto",
        })
        return
      }

      if (!mpResult.valid) {
        setValidationResult({
          valid: false,
          message: mpResult.message || "‚ùå Pagamento inv√°lido",
          type: "error",
          details: mpResult.details,
        })
        return
      }

      // ETAPA 3: Tudo OK!
      setValidationResult({
        valid: true,
        message: "‚úÖ Pagamento v√°lido e dispon√≠vel",
        type: "success",
        details: `Valor: R$ ${mpResult.amount} | Status: ${mpResult.status}`,
        paymentData: mpResult.paymentData,
      })
    } catch (error) {
      console.error("Erro na valida√ß√£o:", error)
      setValidationResult({
        valid: false,
        message: "‚ùå Erro ao validar pagamento",
        type: "error",
        details: "Verifique sua conex√£o e tente novamente",
      })
    } finally {
      setValidating(false)
    }
  }

  // Fun√ß√£o chamada quando o usu√°rio digita
  function handlePaymentIdChange(value) {
    setPaymentId(value)
    setResult(null)

    // Validar ap√≥s 800ms de pausa na digita√ß√£o (debounce)
    clearTimeout(window.paymentValidationTimeout)
    window.paymentValidationTimeout = setTimeout(() => {
      validatePaymentId(value)
    }, 800)
  }

  async function activateSubscriptionDirect() {
    // Verificar se o payment_id √© v√°lido antes de prosseguir
    if (!validationResult || !validationResult.valid) {
      alert("‚ùå Por favor, insira um ID de pagamento v√°lido e dispon√≠vel")
      return
    }

    if (!paymentId.trim()) {
      alert("Digite o ID do pagamento")
      return
    }

    if (
      !confirm(
        `Tem certeza que deseja ativar a assinatura premium?\n\nPagamento: ${paymentId}\nValor: ${validationResult.details}`,
      )
    ) {
      return
    }

    setLoading(true)
    setResult(null)

    try {
      console.log("=== Iniciando ativa√ß√£o da assinatura ===")

      // Usar os dados do pagamento j√° validados
      const paymentData = validationResult.paymentData

      // Criar nova assinatura
      const startDate = new Date()
      const endDate = new Date()
      endDate.setDate(endDate.getDate() + 30)

      const subscriptionData = {
        user_id: user.id,
        plan_type: "premium",
        status: "active",
        start_date: startDate.toISOString(),
        end_date: endDate.toISOString(),
        payment_method: paymentData.payment_method_id || "pix",
        payment_id: paymentId.trim(),
        amount: paymentData.transaction_amount || 9.9,
        currency: paymentData.currency_id || "BRL",
      }

      const { data: newSubscription, error: subscriptionError } = await supabase
        .from("subscriptions")
        .insert([subscriptionData])
        .select()
        .single()

      if (subscriptionError) {
        console.error("Erro ao criar assinatura:", subscriptionError)

        // Se for erro de constraint √∫nico (payment_id duplicado)
        if (subscriptionError.code === "23505") {
          setResult({
            success: false,
            error: "üö® Este ID de pagamento j√° foi utilizado",
            details: "Algu√©m utilizou este ID enquanto voc√™ estava processando",
          })
          // Revalidar o payment ID
          validatePaymentId(paymentId)
          return
        }

        throw new Error("Erro ao criar assinatura: " + subscriptionError.message)
      }

      // Atualizar perfil do usu√°rio
      const { data: updatedProfile, error: profileError } = await supabase
        .from("profiles")
        .update({
          role: "admin",
          subscription_status: "premium",
          subscription_end_date: endDate.toISOString(),
        })
        .eq("id", user.id)
        .select()
        .single()

      if (profileError) {
        console.error("Erro ao atualizar perfil:", profileError)
        throw new Error("Erro ao atualizar perfil: " + profileError.message)
      }

      setResult({
        success: true,
        message: "üéâ Assinatura Premium ativada com sucesso!",
        subscription: newSubscription,
        profile: updatedProfile,
        nextSteps: "Recarregue a p√°gina para ver as mudan√ßas",
      })

      alert("üéâ Assinatura Premium ativada com sucesso!\n\nRecarregue a p√°gina para acessar todos os recursos.")

      setTimeout(() => {
        window.location.reload()
      }, 3000)
    } catch (error) {
      console.error("Erro na ativa√ß√£o:", error)
      setResult({
        success: false,
        error: error.message,
        details: error,
      })
    } finally {
      setLoading(false)
    }
  }

  async function checkCurrentStatus() {
    try {
      const { data: currentProfile, error: profileError } = await supabase
        .from("profiles")
        .select("*")
        .eq("id", user.id)
        .single()

      if (profileError) {
        throw new Error("Erro ao verificar perfil: " + profileError.message)
      }

      const { data: subscriptions, error: subError } = await supabase
        .from("subscriptions")
        .select("*")
        .eq("user_id", user.id)
        .order("created_at", { ascending: false })

      if (subError) {
        throw new Error("Erro ao verificar assinaturas: " + subError.message)
      }

      setResult({
        success: true,
        message: "Status atual verificado",
        currentProfile: currentProfile,
        subscriptions: subscriptions,
      })
    } catch (error) {
      setResult({
        success: false,
        error: error.message,
      })
    }
  }

  return (
    <div className="debug-panel">
      <h3>üîß Ativa√ß√£o Manual de Assinatura Premium</h3>

      <div className="debug-section">
        <h4>‚úÖ Ativar Sua Assinatura</h4>
        <p>
          <strong>Insira o ID do seu pagamento aprovado:</strong>
        </p>

        <div className="payment-check">
          <div className="payment-input-container">
            <input
              type="text"
              value={paymentId}
              onChange={(e) => handlePaymentIdChange(e.target.value)}
              placeholder="ID do Pagamento (ex: 113535423120)"
              className={`payment-input ${validationResult ? (validationResult.valid ? "valid" : "invalid") : ""}`}
              disabled={loading}
            />

            {/* Indicador de valida√ß√£o */}
            <div className="validation-indicator">
              {validating && <span className="validating">üîÑ</span>}
              {validationResult && !validating && (
                <span className={`validation-icon ${validationResult.type}`}>
                  {validationResult.type === "success" && "‚úÖ"}
                  {validationResult.type === "warning" && "‚ö†Ô∏è"}
                  {validationResult.type === "error" && "‚ùå"}
                </span>
              )}
            </div>
          </div>

          {/* Mensagem de valida√ß√£o */}
          {validationResult && (
            <div className={`validation-message ${validationResult.type}`}>
              <p>{validationResult.message}</p>
              {validationResult.details && <small>{validationResult.details}</small>}
            </div>
          )}

          <button
            onClick={activateSubscriptionDirect}
            disabled={loading || !validationResult || !validationResult.valid}
            className={`process-btn ${validationResult && validationResult.valid ? "enabled" : "disabled"}`}
          >
            {loading ? "üîÑ Ativando..." : "üöÄ Ativar Premium"}
          </button>
        </div>

        <div className="status-check">
          <button onClick={checkCurrentStatus} className="status-btn">
            üìä Verificar Status Atual
          </button>
        </div>

        {/* <div className="payment-info">
          <h5>üîç Valida√ß√£o em 3 Etapas:</h5>
          <ul>
            <li>
              ‚úÖ <strong>Etapa 1:</strong> Verifica se o ID j√° foi usado no sistema
            </li>
            <li>
              üîç <strong>Etapa 2:</strong> Confirma se o pagamento existe no Mercado Pago
            </li>
            <li>
              ‚úÖ <strong>Etapa 3:</strong> Valida se o pagamento foi aprovado e pertence a voc√™
            </li>
          </ul>

          <h5>üö® Prote√ß√µes de Seguran√ßa:</h5>
          <ul>
            <li>‚ùå IDs inventados s√£o rejeitados</li>
            <li>üö´ IDs j√° utilizados s√£o bloqueados</li>
            <li>üîí Pagamentos de outras contas s√£o negados</li>
            <li>‚ö†Ô∏è Apenas pagamentos aprovados s√£o aceitos</li>
          </ul>

          <h5>üéØ O que voc√™ receber√°:</h5>
          <ul>
            <li>‚úÖ Acesso completo como administrador</li>
            <li>‚úÖ Upload ilimitado de imagens e v√≠deos</li>
            <li>‚úÖ Gerenciamento de diret√≥rios</li>
            <li>‚úÖ Edi√ß√£o de m√≠dias</li>
            <li>‚úÖ Relat√≥rios avan√ßados</li>
          </ul>
        </div> */}

        {result && (
          <div className={`result ${result.success ? "success" : "error"}`}>
            <h5>{result.success ? "‚úÖ Sucesso!" : "‚ùå Erro:"}</h5>
            {result.message && <p className="result-message">{result.message}</p>}
            {result.nextSteps && <p className="next-steps">{result.nextSteps}</p>}
            <details>
              <summary>Ver detalhes t√©cnicos</summary>
              <pre>{JSON.stringify(result, null, 2)}</pre>
            </details>
          </div>
        )}
      </div>

      <div className="debug-section">
        <h4>üë§ Informa√ß√µes da Conta</h4>
        <div className="user-info-debug">
          <p>
            <strong>ID:</strong> {user.id}
          </p>
          <p>
            <strong>Email:</strong> {user.email}
          </p>
          <p>
            <strong>Nome:</strong> {user.username}
          </p>
          <p>
            <strong>Role Atual:</strong>{" "}
            <span className={`role-badge ${user.role}`}>{user.role === "admin" ? "üëë Admin" : "üë§ Usu√°rio"}</span>
          </p>
          <p>
            <strong>Status:</strong>{" "}
            <span className={`status-badge ${user.subscription_status || "none"}`}>
              {user.subscription_status === "premium" ? "üíé Premium" : "üÜì Gratuito"}
            </span>
          </p>
          <p>
            <strong>Vencimento:</strong> {user.subscription_end_date || "N/A"}
          </p>
        </div>
      </div>
    </div>
  )
}

export default AdminDebugPanel
